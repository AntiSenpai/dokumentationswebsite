{# templates/customer/index.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Kundenverzeichnis{% endblock %}

{% block topNav %}
    <div>
        <h1 style="color:#243668;">Schnelldokumentation<h1>
    </div>
{% endblock %}

{% block body %}
<link rel="stylesheet" href="{{ asset('css/customer.css') }}">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="{{ asset('js/doku.js') }}"></script>

<div class="search-add-box">
    <div class="search-box">
        <input type="text" id="customerSearch" placeholder="Kunden suchen...">
        <button class="search-btn"><i class="fas fa-search"></i></button>
    </div>
    <div class="buttons">
    <button type="button" class="btn btn-primary" id="archiveButton">
        <i class="fas fa-archive"></i> Archiv
    </button>
    <button type="button" class="btn btn-primary" id="addCustomerButton">
        <i class="fas fa-user-plus"></i> Neu
    </button>
    </div>
</div>

<div class="header-container">
    <h2>Kundenverzeichnis</h2>
    <button id="refreshCustomerList" class=" btn refreshbutton" style="margin-top: 1vw">
        <i class="fas fa-sync-alt"></i>
    </button>
    <button type="button" class="btn btn-primary" id="archiveSelectedButton" disabled>
        <i class="fas fa-archive"></i> Auswahl Archivieren
    </button>
</div>

<div class="customer-list">
    <div class="customer-list-header">
        <div class="header-checkbox"><input type="checkbox" id="selectAll"></div>
        <div class="header-id" title="ID">ID:</div>
        <div class="header-name" title="Name">Kunde:</div>
        <div class="header-created" title="Erstellt am">Erstellt am:</div>
        <div class="header-updated" title="Geändert">Geändert um:</div>
        <div class="header-updatedby" title="Geändert von">Geändert von:</div>
    </div>
    {% for customer in customers %}
        <div class="customer-entry {% if loop.index is odd %}customer-odd{% endif %}">
            <div class="entry-checkbox"><input type="checkbox" class="customer-checkbox" data-id="{{ customer.id }}"></div>
            <a href="{{ path('customer_detail', {'id': customer.id}) }}" class="customer-entry-link">
                <div class="entry-id">{{ customer.suchnummer }}</div>
                <div class="entry-name">{{ customer.name }}</div>
                <div class="entry-created">{{ customer.createdAt|date('d.m.Y') }}</div>
                <div class="entry-updated">{{ customer.updatedAt|date('H:i') }}</div>
                <div class="entry-updatedby">{{ customer.updatedBy.username }}</div>
            </a>
        </div>
    {% else %}
        <p>Keine Kunden gefunden.</p>
    {% endfor %}
</div>
<div class="pagination-container">
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% for i in 1..totalPages %}
                <li class="page-item{{ currentPage == i ? ' active' : '' }}">
                    <a class="page-link" href="{{ path('customer_index', {'page': i}) }}">{{ i }}</a>
                </li>
            {% endfor %}
        </ul>
    </nav>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const archiveButton = document.getElementById('archiveButton');
    const archiveSelectedButton = document.getElementById('archiveSelectedButton');
    const selectAllCheckbox = document.getElementById('selectAll');
    const customerCheckboxes = document.querySelectorAll('.customer-checkbox');

    archiveButton.addEventListener('click', function() {
        Swal.fire({
            title: 'Archivierte Kunden',
            html: '<div id="archivedCustomersList"></div>',
            showCloseButton: true,
            showCancelButton: false,
            showConfirmButton: false,
            didOpen: function() {
                fetch('{{ path('customer_archived') }}')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('archivedCustomersList').innerHTML = html;
                    document.querySelectorAll('.activate-button').forEach(button => {
                        button.addEventListener('click', function() {
                            const customerId = this.dataset.id;
                            fetch('/doku/customer/activate/' + customerId, {
                                method: 'POST'
                            }).then(() => {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Kunde reaktiviert',
                                    timer: 1500,
                                    timerProgressBar: true,
                                    toast: true,
                                    position: 'top-end',
                                    showConfirmButton: false
                                }).then(() => location.reload());
                            });
                        });
                    });
                });
            }
        });
    });

    selectAllCheckbox.addEventListener('change', function() {
        const isChecked = selectAllCheckbox.checked;
        customerCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        toggleArchiveSelectedButton();
    });

    customerCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', toggleArchiveSelectedButton);
    });

    function toggleArchiveSelectedButton() {
        const anyChecked = Array.from(customerCheckboxes).some(checkbox => checkbox.checked);
        archiveSelectedButton.disabled = !anyChecked;
    }

    archiveSelectedButton.addEventListener('click', function() {
        const selectedCustomerIds = Array.from(customerCheckboxes)
            .filter(checkbox => checkbox.checked)
            .map(checkbox => checkbox.dataset.id);

        if (selectedCustomerIds.length > 0) {
            Swal.fire({
                title: 'Möchten Sie die ausgewählten Kunden wirklich archivieren?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ja, archivieren!',
                cancelButtonText: 'Abbrechen'
            }).then((result) => {
                if (result.isConfirmed) {
                    selectedCustomerIds.forEach(customerId => {
                        fetch('/doku/customer/archive/' + customerId, {
                            method: 'POST'
                        }).then(() => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Kunde archiviert',
                                timer: 1500,
                                timerProgressBar: true,
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false
                            }).then(() => location.reload());
                        });
                    });
                }
            });
        }
    });
});
</script>
{% endblock %}
